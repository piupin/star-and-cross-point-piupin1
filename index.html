<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stars</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#FFD700" />
  <style>
    :root{
      --bg:#fff8e1;
      --card:#ffffff;
      --head:#ffeb3b;
      --border:#ffcc80;
      --text:#333;
      --hover:#ffe082;
      --shadow:0 4px 8px rgba(0,0,0,.2);
    }
    body.naughty {
      --bg:#0a0a0a;
      --card:#121212;
      --head:#2a0000;
      --border:#3a0000;
      --text:#f8d7da;
      --hover:#1a0000;
      --shadow:0 6px 14px rgba(255,0,0,.15);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:"Comic Sans MS",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:12px;
      transition:background .25s ease,color .25s ease;
    }

    .topbar{
      width:100%;max-width:720px;
      display:flex;align-items:center;justify-content:space-between;
      position:sticky;top:0;padding:8px 6px;
      backdrop-filter:saturate(140%) blur(6px);
      z-index:10;
    }
    h1{margin:0;font-size:1.6rem;color:#ff5722;cursor:pointer}
    body.naughty h1{color:#ff3b3b}

    .switch-wrap{display:flex;align-items:center;gap:8px}
    .switch{position:relative;width:58px;height:30px}
    .switch input{display:none}
    .slider{position:absolute;inset:0;background:#ffd54f;border-radius:999px;
      box-shadow:inset 0 2px 6px rgba(0,0,0,.25);transition:background .25s ease}
    .knob{position:absolute;top:3px;left:3px;width:24px;height:24px;border-radius:50%;
      background:#fff;display:flex;align-items:center;justify-content:center;
      font-size:15px;transition:transform .25s ease;box-shadow:0 2px 6px rgba(0,0,0,.25)}
    input:checked+.slider{background:#8b0000}
    input:checked+.slider .knob{transform:translateX(28px)}

    .table-wrap{width:100%;max-width:720px;background:var(--card);
      border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
    table{width:100%;border-collapse:collapse;background:var(--card)}
    thead th{background:var(--head);color:#333;text-align:center;
      padding:10px;font-weight:700}
    tbody td{border-top:2px solid var(--border);padding:10px;font-size:16px;text-align:center}
    tbody tr:nth-child(even){background:rgba(255,255,255,.35)}
    body.naughty tbody tr:nth-child(even){background:#151515}
    tbody tr:hover{background:var(--hover)}

    .badge{margin:6px 0 2px;padding:6px 10px;border-radius:999px;font-weight:700;font-size:.9rem;
      background:#fff3cd;color:#795548;display:inline-flex;align-items:center;gap:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.1)}
    body.naughty .badge{background:#330000;color:#ffb3b3}
    .empty{padding:18px;text-align:center;opacity:.8}

    .notice-wrap{width:100%;max-width:720px;background:var(--card);
      border-radius:10px;box-shadow:var(--shadow);margin-top:12px;padding:10px 14px}
    .notice-wrap h2{margin:0 0 6px;font-size:1.1rem;color:#d32f2f}
    body.naughty .notice-wrap h2{color:#ff6666}
    .notice-item{margin:4px 0;font-size:.95rem;line-height:1.3}

    /* 3-dot menu */
    .menu-btn{font-size:22px;background:none;border:none;cursor:pointer}
    .side-menu{position:fixed;top:0;right:-75%;width:75%;height:100%;
      background:var(--card);box-shadow:-2px 0 8px rgba(0,0,0,.3);
      transition:right .3s ease;z-index:1000;overflow-y:auto;padding:20px}
    .side-menu.open{right:0}
    .menu-overlay{position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,.4);backdrop-filter:blur(4px);opacity:0;pointer-events:none;
      transition:opacity .3s ease;z-index:999}
    .menu-overlay.show{opacity:1;pointer-events:auto}

    .menu-section{margin:15px 0}
    .menu-section h3{margin:10px 0;font-size:1.1rem;color:#ff5722;cursor:pointer}
    .submenu{display:none;margin-left:12px}
    .submenu.open{display:block}

    /* Buttons inside sit plan */
    .teacher-btn{margin-top:10px;padding:6px 10px;border:none;border-radius:6px;
      cursor:pointer;background:#ff9800;color:#fff}
    .teacher-btn:hover{background:#e68900}

    /* Update banner */
    .update-banner{display:none;position:fixed;bottom:20px;left:50%;
      transform:translateX(-50%);background:#4caf50;color:#fff;padding:10px 18px;
      border-radius:8px;font-size:.95rem;box-shadow:0 2px 6px rgba(0,0,0,.3);
      z-index:2000}
    .update-banner.show{display:block}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="switch-wrap">
      <label class="switch">
        <input id="modeToggle" type="checkbox">
        <div class="slider"><div class="knob">üåü</div></div>
      </label>
      <span class="mode-label" id="modeLabel">Stars</span>
    </div>
    <h1 id="titleTap">Student Points</h1>
    <button class="menu-btn" onclick="openMenu()">‚ãÆ</button>
  </div>

  <div class="badge" id="modeBadge">üåü Stars Ranking</div>

  <div class="table-wrap">
    <table id="studentTable">
      <thead><tr><th>No.</th><th>Name</th><th id="pointsHeader">Stars</th><th>Total</th></tr></thead>
      <tbody><tr><td class="empty" colspan="4">Loading‚Ä¶</td></tr></tbody>
    </table>
  </div>

  <div class="notice-wrap" id="noticeSection">
    <h2 id="noticeTitle">Notices</h2>
    <div id="noticeList">Loading‚Ä¶</div>
  </div>

  <!-- Side menu -->
  <div class="side-menu" id="sideMenu">
    <div class="menu-section">
      <h3 onclick="toggleSubmenu('materialsMenu')">üìò Study Materials</h3>
      <div id="materialsMenu" class="submenu"></div>
    </div>
    <div class="menu-section">
      <h3 onclick="toggleSubmenu('sitPlanMenu')">ü™ë Sit Plan</h3>
      <div id="sitPlanMenu" class="submenu">
        <div id="sitPlanList">Loading‚Ä¶</div>
        <button id="shuffleBtn" class="teacher-btn" style="display:none" onclick="shuffleSitPlan()">Shuffle</button>
        <button id="copyBtn" class="teacher-btn" style="display:none" onclick="copySitPlan()">Copy</button>
      </div>
    </div>
  </div>
  <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

  <div class="update-banner" id="updateBanner">‚úÖ App updated to latest version</div>

  <footer style="margin-top:20px;font-size:.8rem;color:#888;text-align:center;opacity:0.7;">
    Made by Piu
  </footer>

  <script>
    const sheetID = "1dpFvFkYwTw4B8laeTQ21mrN78w5P97W3wohI7Pa_2pk"; // main sheet
    const pdfSheetID = "1HFAC0O7INymniAzrQarBPK8Jfyg3lTWBzg22cxg2wVg"; // pdf sheet
    const mainSheetURL = id => `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json`;

    const tbody=document.querySelector("#studentTable tbody");
    const modeToggle=document.querySelector("#modeToggle");
    const modeLabel=document.querySelector("#modeLabel");
    const modeBadge=document.querySelector("#modeBadge");
    const pointsHeader=document.querySelector("#pointsHeader");
    const knob=document.querySelector(".knob");
    const noticeTitle=document.getElementById("noticeTitle");
    const noticeList=document.getElementById("noticeList");
    let dataRows=[];let currentMode="stars";

    function countEmojis(str,regex){if(!str)return 0;const m=str.match(regex);return m?m.length:0}
    function renderTable(){tbody.innerHTML="";const rows=[];dataRows.forEach(row=>{
      const name=row.c[0]?.v||"";const starsStr=row.c[1]?.v||"";const naughtyStr=row.c[2]?.v||"";
      if(!name.trim())return;const starsTotal=countEmojis(starsStr,/üåü/g);
      const naughtyTotal=countEmojis(naughtyStr,/‚ùå/g);
      rows.push({name,raw:currentMode==="stars"?starsStr:naughtyStr,total:currentMode==="stars"?starsTotal:naughtyTotal});
    });rows.sort((a,b)=>b.total-a.total);
    rows.forEach((r,idx)=>{let rank=idx+1;if(currentMode==="stars"){if(idx===0)rank="ü•á";else if(idx===1)rank="ü•à";else if(idx===2)rank="ü•â"}else{if(idx===0)rank="‚ò†Ô∏è";else if(idx===1)rank="üíÄ";else if(idx===2)rank="ü¶¥"}
      const tr=document.createElement("tr");tr.innerHTML=`<td>${rank}</td><td>${r.name}</td><td>${r.raw||""}</td><td>${r.total}</td>`;tbody.appendChild(tr)});if(rows.length===0)tbody.innerHTML=`<tr><td class="empty" colspan="4">No data</td></tr>`}
    function renderNotices(){noticeList.innerHTML="";if(currentMode==="stars"){noticeTitle.textContent="Notices";dataRows.forEach(r=>{const n=r.c[3]?.v||"";if(n.trim()){const d=document.createElement("div");d.className="notice-item";d.textContent="‚Ä¢ "+n;noticeList.appendChild(d)}})}else{noticeTitle.textContent="Reasons";dataRows.forEach(r=>{const reason=r.c[4]?.v||"";if(reason.trim()){const d=document.createElement("div");d.className="notice-item";d.textContent="‚Ä¢ "+reason;noticeList.appendChild(d)}})}if(!noticeList.innerHTML.trim())noticeList.textContent="No entries"}
    function applyModeUI(){if(currentMode==="stars"){document.body.classList.remove("naughty");modeLabel.textContent="Stars";modeBadge.textContent="üåü Stars Ranking";pointsHeader.textContent="Stars";knob.textContent="üåü"}else{document.body.classList.add("naughty");modeLabel.textContent="Naughty";modeBadge.textContent="‚ùå Naughty Ranking";pointsHeader.textContent="Naughty";knob.textContent="‚ùå"}}
    function fetchData(){fetch(mainSheetURL(sheetID)+"&tq="+encodeURIComponent("SELECT A,B,F,M,P"))
      .then(res=>res.text()).then(text=>{const json=JSON.parse(text.substr(47).slice(0,-2));dataRows=json.table.rows||[];renderTable();renderNotices()})
      .catch(()=>{tbody.innerHTML=`<tr><td class="empty" colspan="4">Offline</td></tr>`;noticeList.textContent="Offline"})}

    // Study Materials
    function loadMaterials(){fetch(mainSheetURL(pdfSheetID)).then(r=>r.text()).then(txt=>{
      const json=JSON.parse(txt.substr(47).slice(0,-2));const rows=json.table.rows||[];
      const container=document.getElementById("materialsMenu");container.innerHTML="";
      const subjects={};rows.forEach(r=>{const subj=r.c[0]?.v;const chap=r.c[1]?.v;const link=r.c[2]?.v;
        if(!subj||!chap||!link)return;if(!subjects[subj])subjects[subj]=[];subjects[subj].push({chap,link})});
      for(const [s,chs] of Object.entries(subjects)){const h=document.createElement("h4");h.textContent=s;container.appendChild(h);
        chs.forEach(c=>{const a=document.createElement("a");a.href=c.link;a.target="_blank";a.textContent="‚Ä¢ "+c.chap;
          a.style.display="block";a.style.marginLeft="10px";container.appendChild(a)})}})
    }

    // Sit Plan
    let sitPlanNames=[];
    function loadSitPlan(){fetch(mainSheetURL(sheetID)+"&tq="+encodeURIComponent("SELECT I"))
      .then(r=>r.text()).then(txt=>{const json=JSON.parse(txt.substr(47).slice(0,-2));const rows=json.table.rows||[];
        sitPlanNames=rows.map(r=>r.c[0]?.v).filter(Boolean);renderSitPlan(sitPlanNames)})
      .catch(()=>{document.getElementById("sitPlanList").textContent="Offline"})}
    function renderSitPlan(list){const cont=document.getElementById("sitPlanList");cont.innerHTML="";list.forEach((n,i)=>{const d=document.createElement("div");d.textContent=`${i+1}. ${n}`;cont.appendChild(d)})}
    function shuffleSitPlan(){const shuffled=[...sitPlanNames].sort(()=>Math.random()-0.5);renderSitPlan(shuffled)}
    function copySitPlan(){const cont=document.getElementById("sitPlanList");let text="";cont.querySelectorAll("div").forEach(d=>{text+=d.textContent+"\n"});navigator.clipboard.writeText(text).then(()=>alert("Copied to clipboard!"))}

    // Menu controls
    function openMenu(){document.getElementById("sideMenu").classList.add("open");document.getElementById("menuOverlay").classList.add("show");document.body.style.overflow="hidden"}
    function closeMenu(){document.getElementById("sideMenu").classList.remove("open");document.getElementById("menuOverlay").classList.remove("show");document.body.style.overflow=""}
    function toggleSubmenu(id){document.getElementById(id).classList.toggle("open")}

    // Hidden teacher login
    let tapCount=0;document.getElementById("titleTap").addEventListener("click",()=>{tapCount++;if(tapCount>=3){tapCount=0;askPassword()}setTimeout(()=>tapCount=0,1000)});
    function askPassword(){fetch(mainSheetURL(sheetID)+"&tq="+encodeURIComponent("SELECT W"))
      .then(r=>r.text()).then(txt=>{const json=JSON.parse(txt.substr(47).slice(0,-2));const pass=json.table.rows[0].c[0].v;
        const input=prompt("Enter Teacher Password:");if(input===pass){document.getElementById("shuffleBtn").style.display="inline-block";document.getElementById("copyBtn").style.display="inline-block";alert("Teacher mode enabled")}})
    }

    modeToggle.addEventListener("change",()=>{currentMode=modeToggle.checked?"naughty":"stars";applyModeUI();renderTable();renderNotices()});
    applyModeUI();fetchData();loadMaterials();loadSitPlan();

    if("serviceWorker" in navigator){
      window.addEventListener("load",()=>{navigator.serviceWorker.register("./service-worker.js").catch(console.warn)});
      navigator.serviceWorker.addEventListener("message",(e)=>{if(e.data.action==="reload"){location.reload()}});
    }
  </script>
</body>
</html>
