<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stars</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#FFD700" />
  <style>
    :root{
      --bg:#fff8e1;
      --card:#ffffff;
      --head:#ffeb3b;
      --border:#ffcc80;
      --text:#333;
      --hover:#ffe082;
      --shadow:0 4px 8px rgba(0,0,0,.2);
    }
    body.naughty {
      --bg:#0a0a0a;
      --card:#121212;
      --head:#2a0000;
      --border:#3a0000;
      --text:#f8d7da;
      --hover:#1a0000;
      --shadow:0 6px 14px rgba(255,0,0,.15);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: "Comic Sans MS", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:12px;
      transition:background .25s ease, color .25s ease;
    }

    .topbar{
      width:100%;
      max-width:720px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      padding:8px 6px;
      backdrop-filter:saturate(140%) blur(6px);
      z-index:10;
    }

    h1{
      margin:0 0 6px 0;
      font-size:1.6rem;
      color:#ff5722;
      transition:color .25s ease;
    }
    body.naughty h1{ color:#ff3b3b; }

    .switch-wrap{ display:flex; align-items:center; gap:8px; }
    .mode-label{ font-size:.95rem; user-select:none; }
    .switch{ position:relative; width:58px; height:30px; }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0; background:#ffd54f; border-radius:999px;
      box-shadow:inset 0 2px 6px rgba(0,0,0,.25);
      transition:background .25s ease;
    }
    .knob{
      position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%;
      background:#fff; display:flex; align-items:center; justify-content:center;
      font-size:15px; transition:transform .25s ease;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    input:checked + .slider{ background:#8b0000; }
    input:checked + .slider .knob{ transform:translateX(28px); }

    .table-wrap{
      width:100%; max-width:720px; background:var(--card);
      border-radius:12px; overflow:hidden; box-shadow:var(--shadow);
    }
    table{ width:100%; border-collapse:collapse; background:var(--card); }
    thead th{
      background:var(--head); color:#333; text-align:center;
      padding:10px; font-weight:700;
    }
    tbody td{
      border-top:2px solid var(--border);
      padding:10px; font-size:16px; text-align:center;
    }
    tbody tr:nth-child(even){ background:rgba(255,255,255,.35); }
    body.naughty tbody tr:nth-child(even){ background:#151515; }
    tbody tr:hover{ background:var(--hover); }

    th:nth-child(1), td:nth-child(1){ width:40px; }
    th:nth-child(2), td:nth-child(2){ width:32%; text-align:left; }
    th:nth-child(3), td:nth-child(3){ width:auto; text-align:left; word-break:break-word; font-size:20px; }
    th:nth-child(4), td:nth-child(4){ width:64px; }

    .badge{
      margin:6px 0 2px; padding:6px 10px; border-radius:999px; font-weight:700; font-size:.9rem;
      background:#fff3cd; color:#795548; display:inline-flex; align-items:center; gap:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
    }
    body.naughty .badge{ background:#330000; color:#ffb3b3; }

    .empty{ padding:18px; text-align:center; opacity:.8; }

    /* Notices / Reasons */
    .notice-wrap{
      width:100%; max-width:720px;
      background:var(--card);
      border-radius:10px;
      box-shadow:var(--shadow);
      margin-top:12px;
      padding:10px 14px;
    }
    .notice-wrap h2{
      margin:0 0 6px;
      font-size:1.1rem;
      color:#d32f2f;
    }
    .notice-item{
      margin:4px 0;
      font-size:.95rem;
      line-height:1.3;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="switch-wrap">
      <label class="switch">
        <input id="modeToggle" type="checkbox" aria-label="Toggle Naughty Mode">
        <div class="slider"><div class="knob">üåü</div></div>
      </label>
      <span class="mode-label" id="modeLabel">Stars</span>
    </div>
    <h1>Student Points</h1>
  </div>

  <div class="badge" id="modeBadge">üåü Stars Ranking</div>

  <div class="table-wrap">
    <table id="studentTable">
      <thead>
        <tr>
          <th>No.</th>
          <th>Name</th>
          <th id="pointsHeader">Stars</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody><tr><td class="empty" colspan="4">Loading‚Ä¶</td></tr></tbody>
    </table>
  </div>

  <!-- Notices/Reasons go here -->
  <div class="notice-wrap" id="noticeSection">
    <h2 id="noticeTitle">Notices</h2>
    <div id="noticeList">Loading‚Ä¶</div>
  </div>

  <script>
    const sheetID = "1dpFvFkYwTw4B8laeTQ21mrN78w5P97W3wohI7Pa_2pk";
    const sheetName = "Sheet1";

    // We fetch A (names), B (stars), F (naughty), M (notices), P (reasons)
    const query = encodeURIComponent("SELECT A,B,F,M,P");
    const baseURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}&tq=${query}`;

    const tbody = document.querySelector("#studentTable tbody");
    const modeToggle = document.querySelector("#modeToggle");
    const modeLabel  = document.querySelector("#modeLabel");
    const modeBadge  = document.querySelector("#modeBadge");
    const pointsHeader = document.querySelector("#pointsHeader");
    const knob = document.querySelector(".knob");

    const noticeSection = document.getElementById("noticeSection");
    const noticeTitle = document.getElementById("noticeTitle");
    const noticeList = document.getElementById("noticeList");

    let dataRows = [];
    let currentMode = "stars";

    function countEmojis(str, emojiRegex){
      if (!str) return 0;
      const m = str.match(emojiRegex);
      return m ? m.length : 0;
    }

    function renderTable(){
      tbody.innerHTML = "";
      const rows = [];

      dataRows.forEach((row) => {
        const name = row.c[0]?.v || "";
        const starsStr = row.c[1]?.v || "";
        const naughtyStr = row.c[2]?.v || "";

        if (!name.trim()) return;

        const starsTotal   = countEmojis(starsStr, /üåü/g);
        const naughtyTotal = countEmojis(naughtyStr, /‚ùå/g);

        rows.push({
          name,
          raw: currentMode === "stars" ? starsStr : naughtyStr,
          total: currentMode === "stars" ? starsTotal : naughtyTotal,
          starsTotal,
          naughtyTotal
        });
      });

      rows.sort((a,b) => b.total - a.total);

      rows.forEach((r, idx) => {
        let rank = idx + 1;
        if (currentMode === "stars"){
          if (idx === 0) rank = "ü•á";
          else if (idx === 1) rank = "ü•à";
          else if (idx === 2) rank = "ü•â";
        } else {
          if (idx === 0) rank = "‚ò†Ô∏è";
          else if (idx === 1) rank = "üíÄ";
          else if (idx === 2) rank = "ü¶¥";
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${rank}</td>
          <td>${r.name}</td>
          <td class="points">${r.raw || ""}</td>
          <td>${r.total}</td>
        `;
        tbody.appendChild(tr);
      });

      if (rows.length === 0){
        tbody.innerHTML = `<tr><td class="empty" colspan="4">No data</td></tr>`;
      }
    }

    function renderNotices(){
      noticeList.innerHTML = "";

      if (currentMode === "stars"){
        noticeTitle.textContent = "Notices";
        dataRows.forEach((row) => {
          const notice = row.c[3]?.v || ""; // M column
          if (notice.trim()){
            const div = document.createElement("div");
            div.className = "notice-item";
            div.textContent = "‚Ä¢ " + notice;
            noticeList.appendChild(div);
          }
        });
      } else {
        noticeTitle.textContent = "Reasons";
        dataRows.forEach((row) => {
          const reason = row.c[4]?.v || ""; // P column
          if (reason.trim()){
            const div = document.createElement("div");
            div.className = "notice-item";
            div.textContent = "‚Ä¢ " + reason;
            noticeList.appendChild(div);
          }
        });
      }

      if (!noticeList.innerHTML.trim()){
        noticeList.textContent = "No entries";
      }
    }

    function applyModeUI(){
      if (currentMode === "stars"){
        document.body.classList.remove("naughty");
        modeLabel.textContent = "Stars";
        modeBadge.textContent = "üåü Stars Ranking";
        pointsHeader.textContent = "Stars";
        knob.textContent = "üåü";
      } else {
        document.body.classList.add("naughty");
        modeLabel.textContent = "Naughty";
        modeBadge.textContent = "‚ùå Naughty Ranking";
        pointsHeader.textContent = "Naughty";
        knob.textContent = "‚ùå";
      }
    }

    function saveCache(){
      try {
        localStorage.setItem("stars_trial_cache_v2", JSON.stringify(dataRows));
      } catch(e){}
    }

    function loadCache(){
      try {
        const raw = localStorage.getItem("stars_trial_cache_v2");
        if (!raw) return false;
        dataRows = JSON.parse(raw);
        return Array.isArray(dataRows);
      } catch(e){ return false; }
    }

    function fetchData(){
      fetch(baseURL)
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substr(47).slice(0, -2));
          dataRows = json.table.rows || [];
          saveCache();
          renderTable();
          renderNotices();
        })
        .catch(() => {
          if (loadCache()){
            renderTable();
            renderNotices();
          } else {
            tbody.innerHTML = `<tr><td class="empty" colspan="4">Offline & no saved data</td></tr>`;
            noticeList.textContent = "Offline & no saved data";
          }
        });
    }

    modeToggle.addEventListener("change", () => {
      currentMode = modeToggle.checked ? "naughty" : "stars";
      applyModeUI();
      renderTable();
      renderNotices();
    });

    applyModeUI();
    fetchData();

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(console.warn);
      });
    }
  </script>
</body>
</html>
