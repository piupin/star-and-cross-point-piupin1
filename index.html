<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stars</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#FFD700" />
  <style>
    :root{
      --bg:#fff8e1;
      --card:#ffffff;
      --head:#ffeb3b;
      --border:#ffcc80;
      --text:#333;
      --hover:#ffe082;
      --shadow:0 4px 8px rgba(0,0,0,.2);
      --accent:#ff5722;
      --danger:#d32f2f;
    }
    body.naughty {
      --bg:#0a0a0a;
      --card:#121212;
      --head:#2a0000;
      --border:#3a0000;
      --text:#f8d7da;
      --hover:#1a0000;
      --shadow:0 6px 14px rgba(255,0,0,.15);
      --accent:#ff3b3b;
      --danger:#ff6666;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: "Comic Sans MS", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:12px;
      transition:background .25s ease, color .25s ease;
    }

    .topbar{
      width:100%;
      max-width:720px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      padding:8px 6px;
      backdrop-filter:saturate(140%) blur(6px);
      z-index:10;
    }

    .left-wrap{
      display:flex; align-items:center; gap:8px;
    }

    h1{
      margin:0 0 6px 0;
      font-size:1.6rem;
      color:var(--accent);
      transition:color .25s ease;
      user-select:none;
    }

    .switch-wrap{ display:flex; align-items:center; gap:8px; }
    .mode-label{ font-size:.95rem; user-select:none; }
    .switch{ position:relative; width:58px; height:30px; }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0; background:#ffd54f; border-radius:999px;
      box-shadow:inset 0 2px 6px rgba(0,0,0,.25);
      transition:background .25s ease;
    }
    .knob{
      position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%;
      background:#fff; display:flex; align-items:center; justify-content:center;
      font-size:15px; transition:transform .25s ease;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    input:checked + .slider{ background:#8b0000; }
    input:checked + .slider .knob{ transform:translateX(28px); }

    /* 3-dot menu button (kept super simple) */
    .menu-btn{
      font-size:22px; line-height:1; background:transparent; border:none; color:var(--text);
      padding:6px 8px; border-radius:8px; cursor:pointer;
    }
    .menu-btn:active{ transform:scale(.96); }

    .table-wrap{
      width:100%; max-width:720px; background:var(--card);
      border-radius:12px; overflow:hidden; box-shadow:var(--shadow);
    }
    table{ width:100%; border-collapse:collapse; background:var(--card); }
    thead th{
      background:var(--head); color:#333; text-align:center;
      padding:10px; font-weight:700;
    }
    tbody td{
      border-top:2px solid var(--border);
      padding:10px; font-size:16px; text-align:center;
    }
    tbody tr:nth-child(even){ background:rgba(255,255,255,.35); }
    body.naughty tbody tr:nth-child(even){ background:#151515; }
    tbody tr:hover{ background:var(--hover); transition:background .15s ease; }

    th:nth-child(1), td:nth-child(1){ width:40px; }
    th:nth-child(2), td:nth-child(2){ width:32%; text-align:left; }
    th:nth-child(3), td:nth-child(3){ width:auto; text-align:left; word-break:break-word; font-size:20px; }
    th:nth-child(4), td:nth-child(4){ width:64px; }

    .badge{
      margin:6px 0 2px; padding:6px 10px; border-radius:999px; font-weight:700; font-size:.9rem;
      background:#fff3cd; color:#795548; display:inline-flex; align-items:center; gap:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
    }
    body.naughty .badge{ background:#330000; color:#ffb3b3; }

    .empty{ padding:18px; text-align:center; opacity:.8; }

    /* Notices / Reasons */
    .notice-wrap{
      width:100%; max-width:720px;
      background:var(--card);
      border-radius:10px;
      box-shadow:var(--shadow);
      margin-top:12px;
      padding:10px 14px;
    }
    .notice-wrap h2{
      margin:0 0 6px;
      font-size:1.1rem;
      color:var(--danger);
    }
    .notice-item{
      margin:4px 0;
      font-size:.95rem;
      line-height:1.3;
    }

    /* Update banner */
    .update-banner {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4caf50;
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 0.95rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: fadeIn 0.4s ease;
    }
    .update-banner.show { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    /* ===== Side Menu (kept minimal; 75% width; blur background; own scroll) ===== */
    .menu-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.2);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      opacity:0; pointer-events:none; transition:opacity .2s ease;
      z-index:100;
    }
    .menu-overlay.show{ opacity:1; pointer-events:auto; }

    .side-menu{
      position:fixed; top:0; right:0; width:75vw; max-width:520px; height:100vh;
      background:var(--card); box-shadow: -8px 0 18px rgba(0,0,0,.18);
      transform:translateX(100%); transition: transform .25s ease;
      z-index:101; display:flex; flex-direction:column;
      overflow-y:auto; -webkit-overflow-scrolling:touch;
    }
    .side-menu.open{ transform:translateX(0); }

    .menu-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:2px solid var(--border); background:var(--head);
    }
    .menu-title{ font-weight:700; }
    .menu-close{ background:transparent; border:none; font-size:20px; cursor:pointer; }

    .menu-section{
      border-bottom:2px solid var(--border);
    }
    .section-toggle{
      width:100%; text-align:left; padding:12px 14px; background:transparent; border:none;
      font-weight:700; font-size:1rem; cursor:pointer;
    }
    .section-toggle:active{ transform:scale(.98); }
    .section-body{ display:none; padding:0 14px 14px; }
    .section-body.open{ display:block; }

    /* Study list look */
    .subject-block{ margin:8px 0 12px; }
    .subject-title{ margin:10px 0 6px; font-weight:700; }
    .pdf-list{ margin:0; padding-left:18px; }
    .pdf-list li{ margin:4px 0; }
    .pdf-list a{ color:var(--accent); text-decoration:none; }
    .pdf-list a:active{ opacity:.8; }

    /* Sit plan list + teacher controls */
    .sit-list{ margin:10px 0; padding-left:20px; }
    .teacher-controls{ display:none; gap:8px; margin:8px 0 0; }
    .btn{
      padding:8px 10px; border-radius:8px; border:none; cursor:pointer; box-shadow:var(--shadow);
      background:#ffe082;
    }
    .btn:active{ transform:scale(.98); }
    .btn.secondary{ background:#fff3cd; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="left-wrap">
      <div class="switch-wrap">
        <label class="switch">
          <input id="modeToggle" type="checkbox" aria-label="Toggle Naughty Mode">
          <div class="slider"><div class="knob">🌟</div></div>
        </label>
        <span class="mode-label" id="modeLabel">Stars</span>
      </div>
      <h1 id="appTitle" title="(teacher login: tap 3×)">Student Points</h1>
    </div>
    <button id="menuBtn" class="menu-btn" aria-label="Open menu">⋮</button>
  </div>

  <div class="badge" id="modeBadge">🌟 Stars Ranking</div>

  <div class="table-wrap">
    <table id="studentTable">
      <thead>
        <tr>
          <th>No.</th>
          <th>Name</th>
          <th id="pointsHeader">Stars</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody><tr><td class="empty" colspan="4">Loading…</td></tr></tbody>
    </table>
  </div>

  <!-- Notices/Reasons -->
  <div class="notice-wrap" id="noticeSection">
    <h2 id="noticeTitle">Notices</h2>
    <div id="noticeList">Loading…</div>
  </div>

  <!-- Update banner -->
  <div class="update-banner" id="updateBanner">✅ App updated to latest version</div>

  <!-- ===== Right Slide Menu + Overlay ===== -->
  <div class="menu-overlay" id="menuOverlay"></div>
  <aside class="side-menu" id="sideMenu" aria-hidden="true">
    <div class="menu-header">
      <div class="menu-title">Menu</div>
      <button class="menu-close" id="menuClose" aria-label="Close">✕</button>
    </div>

    <!-- Study Materials (collapsed by default) -->
    <div class="menu-section">
      <button class="section-toggle" data-target="#secStudy">Study Materials</button>
      <div class="section-body" id="secStudy">
        <div id="studyContainer">Loading…</div>
      </div>
    </div>

    <!-- Sit Plan (collapsed by default) -->
    <div class="menu-section">
      <button class="section-toggle" data-target="#secSit">Sit Plan</button>
      <div class="section-body" id="secSit">
        <ol class="sit-list" id="sitPlanList">Loading…</ol>
        <div class="teacher-controls" id="teacherControls">
          <button class="btn" id="shuffleBtn">Shuffle Sit Plan</button>
          <button class="btn secondary" id="copyBtn">Copy Sit Plan</button>
        </div>
      </div>
    </div>
  </aside>

  <footer style="margin-top:20px; font-size:0.8rem; color:#888; text-align:center; opacity:0.7;">
    Made by Piu
  </footer>

  <script>
    /* =========================
       Google Sheets Setup
       ========================= */
    // Main sheet (points + notices + reasons + password W1 + sit-plan names in column I)
    const MAIN_SHEET_ID = "1dpFvFkYwTw4B8laeTQ21mrN78w5P97W3wohI7Pa_2pk";
    const MAIN_SHEET_NAME = "Sheet1";
    // PDFs sheet (A: Subject, B: Chapter, C: Link)
    const PDF_SHEET_ID = "1HFAC0O7INymniAzrQarBPK8Jfyg3lTWBzg22cxg2wVg";
    const PDF_SHEET_NAME = "Sheet1";

    function gvizURL(id, sheet, tq){
      return `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?sheet=${encodeURIComponent(sheet)}&tq=${encodeURIComponent(tq)}`;
    }

    /* =========================
       DOM refs
       ========================= */
    const tbody = document.querySelector("#studentTable tbody");
    const modeToggle = document.querySelector("#modeToggle");
    const modeLabel  = document.querySelector("#modeLabel");
    const modeBadge  = document.querySelector("#modeBadge");
    const pointsHeader = document.querySelector("#pointsHeader");
    const knob = document.querySelector(".knob");

    const noticeTitle = document.getElementById("noticeTitle");
    const noticeList = document.getElementById("noticeList");

    const appTitle = document.getElementById("appTitle");
    const menuBtn = document.getElementById("menuBtn");
    const sideMenu = document.getElementById("sideMenu");
    const menuOverlay = document.getElementById("menuOverlay");
    const menuClose = document.getElementById("menuClose");
    const sectionToggles = document.querySelectorAll(".section-toggle");
    const studyContainer = document.getElementById("studyContainer");

    const sitPlanList = document.getElementById("sitPlanList");
    const teacherControls = document.getElementById("teacherControls");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const copyBtn = document.getElementById("copyBtn");

    const updateBanner = document.getElementById("updateBanner");

    /* =========================
       State
       ========================= */
    let dataRows = [];
    let currentMode = "stars";
    let teacherMode = false;
    let teacherPassword = "";      // from W1

    let sitPlanBase = [];          // names from column I (sheet order)
    let sitPlanCurrent = [];       // current shown list (shuffled only in-memory)

    /* =========================
       Helpers
       ========================= */
    function countEmojis(str, emojiRegex){
      if (!str) return 0;
      const m = str.match(emojiRegex);
      return m ? m.length : 0;
    }

    function renderTable(){
      tbody.innerHTML = "";
      const rows = [];

      dataRows.forEach((row) => {
        const name = row.c[0]?.v || "";
        const starsStr = row.c[1]?.v || "";
        const naughtyStr = row.c[2]?.v || "";
        if (!name.trim()) return;

        const starsTotal   = countEmojis(starsStr, /🌟/g);
        const naughtyTotal = countEmojis(naughtyStr, /❌/g);

        rows.push({
          name,
          raw: currentMode === "stars" ? starsStr : naughtyStr,
          total: currentMode === "stars" ? starsTotal : naughtyTotal
        });
      });

      rows.sort((a,b) => b.total - a.total);

      rows.forEach((r, idx) => {
        let rank = idx + 1;
        if (currentMode === "stars"){
          if (idx === 0) rank = "🥇";
          else if (idx === 1) rank = "🥈";
          else if (idx === 2) rank = "🥉";
        } else {
          if (idx === 0) rank = "☠️";
          else if (idx === 1) rank = "💀";
          else if (idx === 2) rank = "🦴";
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${rank}</td>
          <td>${r.name}</td>
          <td class="points">${r.raw || ""}</td>
          <td>${r.total}</td>
        `;
        tbody.appendChild(tr);
      });

      if (rows.length === 0){
        tbody.innerHTML = `<tr><td class="empty" colspan="4">No data</td></tr>`;
      }
    }

    function renderNotices(){
      noticeList.innerHTML = "";

      if (currentMode === "stars"){
        noticeTitle.textContent = "Notices";
        dataRows.forEach((row) => {
          const notice = row.c[3]?.v || "";
          if (notice.trim()){
            const div = document.createElement("div");
            div.className = "notice-item";
            div.textContent = "• " + notice;
            noticeList.appendChild(div);
          }
        });
      } else {
        noticeTitle.textContent = "Reasons";
        dataRows.forEach((row) => {
          const reason = row.c[4]?.v || "";
          if (reason.trim()){
            const div = document.createElement("div");
            div.className = "notice-item";
            div.textContent = "• " + reason;
            noticeList.appendChild(div);
          }
        });
      }

      if (!noticeList.innerHTML.trim()){
        noticeList.textContent = "No entries";
      }
    }

    function applyModeUI(){
      if (currentMode === "stars"){
        document.body.classList.remove("naughty");
        modeLabel.textContent = "Stars";
        modeBadge.textContent = "🌟 Stars Ranking";
        pointsHeader.textContent = "Stars";
        knob.textContent = "🌟";
      } else {
        document.body.classList.add("naughty");
        modeLabel.textContent = "Naughty";
        modeBadge.textContent = "❌ Naughty Ranking";
        pointsHeader.textContent = "Naughty";
        knob.textContent = "❌";
      }
    }

    function saveCache(){
      try { localStorage.setItem("stars_trial_cache_v2", JSON.stringify(dataRows)); } catch(e){}
    }
    function loadCache(){
      try {
        const raw = localStorage.getItem("stars_trial_cache_v2");
        if (!raw) return false;
        dataRows = JSON.parse(raw);
        return Array.isArray(dataRows);
      } catch(e){ return false; }
    }

    /* =========================
       Fetchers
       ========================= */
    // Main sheet data (A,B,F,M,P)
    function fetchMainData(){
      const tq = "SELECT A,B,F,M,P";
      return fetch(gvizURL(MAIN_SHEET_ID, MAIN_SHEET_NAME, tq))
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substr(47).slice(0, -2));
          dataRows = json.table.rows || [];
          saveCache();
          renderTable();
          renderNotices();
        })
        .catch(() => {
          if (loadCache()){
            renderTable();
            renderNotices();
          } else {
            tbody.innerHTML = `<tr><td class="empty" colspan="4">Offline & no saved data</td></tr>`;
            noticeList.textContent = "Offline & no saved data";
          }
        });
    }

    // Password from W1 (SELECT W LIMIT 1)
    function fetchPassword(){
      const tq = "SELECT W LIMIT 1";
      return fetch(gvizURL(MAIN_SHEET_ID, MAIN_SHEET_NAME, tq))
        .then(r=>r.text()).then(t=>{
          const j = JSON.parse(t.substr(47).slice(0,-2));
          const v = j.table.rows?.[0]?.c?.[0]?.v || "";
          teacherPassword = String(v || "").trim();
        }).catch(()=>{ teacherPassword=""; });
    }

    // Sit plan names from column I (sheet order for students)
    function fetchSitPlan(){
      const tq = "SELECT I WHERE I IS NOT NULL";
      return fetch(gvizURL(MAIN_SHEET_ID, MAIN_SHEET_NAME, tq))
        .then(r=>r.text()).then(t=>{
          const j = JSON.parse(t.substr(47).slice(0,-2));
          const rows = j.table.rows || [];
          sitPlanBase = rows.map(r => (r.c?.[0]?.v || "").trim()).filter(Boolean);
          resetSitPlanToSheet();
        }).catch(()=>{
          // If failed, just show nothing
          sitPlanBase = [];
          resetSitPlanToSheet();
        });
    }

    // Study materials (A: subject, B: chapter, C: url)
    function fetchStudyMaterials(){
      const tq = "SELECT A,B,C WHERE A IS NOT NULL AND B IS NOT NULL AND C IS NOT NULL";
      studyContainer.textContent = "Loading…";
      return fetch(gvizURL(PDF_SHEET_ID, PDF_SHEET_NAME, tq))
        .then(r=>r.text()).then(t=>{
          const j = JSON.parse(t.substr(47).slice(0,-2));
          const rows = j.table.rows || [];
          const bySubject = {};
          rows.forEach(r=>{
            const subj = (r.c?.[0]?.v || "").trim();
            const chapter = (r.c?.[1]?.v || "").trim();
            const url = (r.c?.[2]?.v || "").trim();
            if(!subj || !chapter || !url) return;
            if(!bySubject[subj]) bySubject[subj] = [];
            bySubject[subj].push({chapter, url});
          });

          // render
          studyContainer.innerHTML = "";
          const subjects = Object.keys(bySubject);
          if (subjects.length === 0){
            studyContainer.textContent = "No study materials.";
            return;
          }
          subjects.forEach(s=>{
            const block = document.createElement("div");
            block.className = "subject-block";
            const h = document.createElement("div");
            h.className = "subject-title";
            h.textContent = (s || "Untitled");
            block.appendChild(h);

            const ul = document.createElement("ul");
            ul.className = "pdf-list";
            bySubject[s].forEach(item=>{
              const li = document.createElement("li");
              const a = document.createElement("a");
              a.href = item.url;
              a.target = "_blank";
              a.rel = "noopener";
              a.textContent = item.chapter;
              li.appendChild(a);
              ul.appendChild(li);
            });
            block.appendChild(ul);
            studyContainer.appendChild(block);
          });
        }).catch(()=>{
          studyContainer.textContent = "Failed to load.";
        });
    }

    /* =========================
       Sit Plan render + actions
       ========================= */
    function resetSitPlanToSheet(){
      // Students always see sheet order unless teacher shuffles
      sitPlanCurrent = sitPlanBase.slice();
      renderSitPlan();
    }

    function renderSitPlan(){
      sitPlanList.innerHTML = "";
      if (sitPlanCurrent.length === 0){
        sitPlanList.innerHTML = "<li>(no names)</li>";
        return;
      }
      sitPlanCurrent.forEach(name=>{
        const li = document.createElement("li");
        li.textContent = name;
        sitPlanList.appendChild(li);
      });
    }

    function shuffleInPlace(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function doShuffle(){
      if (sitPlanBase.length === 0) return;
      sitPlanCurrent = sitPlanBase.slice();
      shuffleInPlace(sitPlanCurrent);
      renderSitPlan();
    }

    function copySitPlan(){
      const text = sitPlanCurrent.join("\n");
      navigator.clipboard.writeText(text).then(()=>{}).catch(()=>{});
    }

    /* =========================
       Menu open/close + collapse sections
       ========================= */
    function openMenu(){
      sideMenu.classList.add("open");
      menuOverlay.classList.add("show");
      document.body.style.overflow = "hidden"; // lock background scroll
      sideMenu.setAttribute("aria-hidden","false");
    }
    function closeMenu(){
      sideMenu.classList.remove("open");
      menuOverlay.classList.remove("show");
      document.body.style.overflow = ""; // restore scroll
      sideMenu.setAttribute("aria-hidden","true");
    }

    menuBtn.addEventListener("click", openMenu);
    menuClose.addEventListener("click", closeMenu);
    menuOverlay.addEventListener("click", closeMenu);

    // collapse toggles (start collapsed)
    sectionToggles.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const target = document.querySelector(btn.dataset.target);
        if (!target) return;
        target.classList.toggle("open");
      });
    });

    /* =========================
       Mode toggle
       ========================= */
    modeToggle.addEventListener("change", () => {
      currentMode = modeToggle.checked ? "naughty" : "stars";
      applyModeUI();
      renderTable();
      renderNotices();
    });

    /* =========================
       Hidden teacher login (tap title 3×)
       ========================= */
    let tapCount = 0;
    let tapTimer = null;

    function enterTeacherMode(){
      teacherMode = true;
      sessionStorage.setItem("teacherMode","1");
      teacherControls.style.display = "flex";
    }
    function exitTeacherMode(){
      teacherMode = false;
      sessionStorage.removeItem("teacherMode");
      teacherControls.style.display = "none";
    }

    appTitle.addEventListener("click", ()=>{
      tapCount++;
      if (tapTimer) clearTimeout(tapTimer);
      tapTimer = setTimeout(()=>{ tapCount = 0; }, 700);
      if (tapCount >= 3){
        tapCount = 0;
        const pwd = prompt("Enter password:");
        if (pwd !== null && teacherPassword && pwd.trim() === teacherPassword){
          enterTeacherMode();
        } else {
          // no change
        }
      }
    });

    // Restore session teacher mode
    if (sessionStorage.getItem("teacherMode") === "1"){
      teacherMode = true;
      teacherControls.style.display = "flex";
    }

    shuffleBtn.addEventListener("click", doShuffle);
    copyBtn.addEventListener("click", copySitPlan);

    /* =========================
       Initial load
       ========================= */
    function init(){
      applyModeUI();
      Promise.all([
        fetchMainData(),
        fetchPassword(),
        fetchSitPlan(),
        fetchStudyMaterials()
      ]).catch(()=>{});
    }
    init();

    /* =========================
       PWA update toast (keep your behavior)
       ========================= */
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(console.warn);
      });

      // Show the green banner when a new SW takes control
      navigator.serviceWorker.addEventListener("controllerchange", () => {
        updateBanner.classList.add("show");
        setTimeout(()=> updateBanner.classList.remove("show"), 4000);
      });

      // If your SW posts {action:'reload'}, do a quick reload
      navigator.serviceWorker.addEventListener("message", (e)=>{
        if (e?.data?.action === "reload") {
          // brief flash of banner then reload
          updateBanner.classList.add("show");
          setTimeout(()=> location.reload(), 600);
        }
      });
    }
  </script>
</body>
</html>
