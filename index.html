<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stars</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#FFD700" />
  <style>
    :root{
      --bg:#fff8e1;
      --card:#ffffff;
      --head:#ffeb3b;
      --border:#ffcc80;
      --text:#333;
      --hover:#ffe082;
      --shadow:0 4px 8px rgba(0,0,0,.2);
    }
    body.naughty {
      --bg:#0a0a0a;
      --card:#121212;
      --head:#2a0000;
      --border:#3a0000;
      --text:#f8d7da;
      --hover:#1a0000;
      --shadow:0 6px 14px rgba(255,0,0,.15);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: "Comic Sans MS", system-ui, sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:12px;
      transition:background .25s ease, color .25s ease;
    }

    .topbar{
      width:100%; max-width:720px;
      display:flex; align-items:center; justify-content:space-between;
      position:sticky; top:0; padding:8px 6px;
      backdrop-filter:saturate(140%) blur(6px);
      z-index:10;
    }

    h1{ margin:0; font-size:1.6rem; color:#ff5722; cursor:pointer; }
    body.naughty h1{ color:#ff3b3b; }

    .switch-wrap{ display:flex; align-items:center; gap:8px; }
    .mode-label{ font-size:.95rem; user-select:none; }
    .switch{ position:relative; width:58px; height:30px; }
    .switch input{ display:none; }
    .slider{ position:absolute; inset:0; background:#ffd54f; border-radius:999px; }
    .knob{ position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%; background:#fff; display:flex; align-items:center; justify-content:center; font-size:15px; transition:transform .25s ease; }
    input:checked + .slider{ background:#8b0000; }
    input:checked + .slider .knob{ transform:translateX(28px); }

    .menu-btn{ font-size:22px; cursor:pointer; }

    .table-wrap{ width:100%; max-width:720px; background:var(--card); border-radius:12px; overflow:hidden; box-shadow:var(--shadow); }
    table{ width:100%; border-collapse:collapse; }
    thead th{ background:var(--head); color:#333; text-align:center; padding:10px; }
    tbody td{ border-top:2px solid var(--border); padding:10px; text-align:center; font-size:16px; }
    tbody tr:nth-child(even){ background:rgba(255,255,255,.35); }
    body.naughty tbody tr:nth-child(even){ background:#151515; }
    tbody tr:hover{ background:var(--hover); }
    td:nth-child(2){ text-align:left; }

    .badge{ margin:6px 0; padding:6px 10px; border-radius:999px; background:#fff3cd; }

    .notice-wrap{ width:100%; max-width:720px; background:var(--card); border-radius:10px; padding:10px; margin-top:10px; box-shadow:var(--shadow); }
    .notice-wrap h2{ margin:0 0 6px; font-size:1.1rem; color:#d32f2f; }

    .update-banner {
      display: none; position: fixed; bottom: 20px; left: 50%;
      transform: translateX(-50%); background: #4caf50; color: #fff;
      padding: 10px 18px; border-radius: 8px; font-size: 0.95rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3); z-index: 2000;
    }
    .update-banner.show { display:block; }

    /* Side menu */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px); opacity:0; pointer-events:none; transition:.3s; z-index:1000; }
    .overlay.show{ opacity:1; pointer-events:auto; }
    .side-menu{ position:fixed; top:0; right:-75%; width:75%; height:100%; background:var(--card); box-shadow:-2px 0 6px rgba(0,0,0,.3); z-index:1001; padding:20px; transition:.3s; overflow-y:auto; }
    .side-menu.open{ right:0; }

    .menu-section{ margin-bottom:15px; }
    .menu-section h3{ margin:0; font-size:1.1rem; cursor:pointer; }
    .menu-content{ display:none; margin-top:8px; }
    .menu-content.show{ display:block; }
    .menu-content a{ display:block; margin:5px 0; color:#007bff; text-decoration:none; }
    .shuffle-btn{ display:none; margin-top:10px; padding:8px; border:none; border-radius:6px; background:#4caf50; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="switch-wrap">
      <label class="switch">
        <input id="modeToggle" type="checkbox">
        <div class="slider"><div class="knob">üåü</div></div>
      </label>
      <span class="mode-label" id="modeLabel">Stars</span>
    </div>
    <h1 id="titleTap">Student Points</h1>
    <div class="menu-btn" onclick="openMenu()">‚ãÆ</div>
  </div>

  <div class="badge" id="modeBadge">üåü Stars Ranking</div>

  <div class="table-wrap"><table id="studentTable"><thead><tr>
    <th>No.</th><th>Name</th><th id="pointsHeader">Stars</th><th>Total</th>
  </tr></thead><tbody><tr><td colspan="4">Loading‚Ä¶</td></tr></tbody></table></div>

  <div class="notice-wrap">
    <h2 id="noticeTitle">Notices</h2>
    <div id="noticeList">Loading‚Ä¶</div>
  </div>

  <!-- Side menu -->
  <div class="overlay" id="menuOverlay" onclick="closeMenu()"></div>
  <div class="side-menu" id="sideMenu">
    <div class="menu-section">
      <h3 onclick="toggleMenu('study')">üìò Study Materials</h3>
      <div id="study" class="menu-content"></div>
    </div>
    <div class="menu-section">
      <h3 onclick="toggleMenu('sit')">ü™ë Sit Plan</h3>
      <div id="sit" class="menu-content"></div>
      <button id="shuffleBtn" class="shuffle-btn" onclick="shuffleSeats()">Shuffle</button>
    </div>
  </div>

  <div class="update-banner" id="updateBanner">‚úÖ App updated</div>

  <footer style="margin-top:20px;font-size:0.8rem;color:#888;text-align:center;opacity:.7;">Made by Piu</footer>

<script>
const mainSheetID="1dpFvFkYwTw4B8laeTQ21mrN78w5P97W3wohI7Pa_2pk";
const pdfSheetID="1HFAC0O7INymniAzrQarBPK8Jfyg3lTWBzg22cxg2wVg";
const mainQuery=encodeURIComponent("SELECT A,B,F,M,P,I,W");
const baseURL=id=>`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&tq=`;

let dataRows=[],pdfRows=[],currentMode="stars",teacher=false,clicks=0;

function countEmojis(str,r){return (str||"").match(r)?.length||0;}

function renderTable(){
  const tbody=document.querySelector("#studentTable tbody");
  tbody.innerHTML="";
  const rows=[];
  dataRows.forEach(r=>{
    const name=r.c[0]?.v||"",stars=r.c[1]?.v||"",naughty=r.c[2]?.v||"";
    if(!name.trim())return;
    rows.push({name,raw:currentMode==="stars"?stars:naughty,total:currentMode==="stars"?countEmojis(stars,/üåü/g):countEmojis(naughty,/‚ùå/g)});
  });
  rows.sort((a,b)=>b.total-a.total);
  rows.forEach((r,i)=>{
    let rank=i+1;
    if(currentMode==="stars"){if(i==0)rank="ü•á";else if(i==1)rank="ü•à";else if(i==2)rank="ü•â";}
    else{if(i==0)rank="‚ò†Ô∏è";else if(i==1)rank="üíÄ";else if(i==2)rank="ü¶¥";}
    tbody.innerHTML+=`<tr><td>${rank}</td><td>${r.name}</td><td>${r.raw||""}</td><td>${r.total}</td></tr>`;
  });
}

function renderNotices(){
  const list=document.getElementById("noticeList");
  list.innerHTML="";
  if(currentMode==="stars"){document.getElementById("noticeTitle").textContent="Notices";
    dataRows.forEach(r=>{const t=r.c[3]?.v;if(t)list.innerHTML+=`<div>‚Ä¢ ${t}</div>`;});
  } else {document.getElementById("noticeTitle").textContent="Reasons";
    dataRows.forEach(r=>{const t=r.c[4]?.v;if(t)list.innerHTML+=`<div>‚Ä¢ ${t}</div>`;});
  }
  if(!list.innerHTML.trim())list.textContent="No entries";
}

function applyModeUI(){
  document.body.classList.toggle("naughty",currentMode==="naughty");
  document.getElementById("modeLabel").textContent=currentMode==="stars"?"Stars":"Naughty";
  document.getElementById("modeBadge").textContent=currentMode==="stars"?"üåü Stars Ranking":"‚ùå Naughty Ranking";
  document.getElementById("pointsHeader").textContent=currentMode==="stars"?"Stars":"Naughty";
  document.querySelector(".knob").textContent=currentMode==="stars"?"üåü":"‚ùå";
}

function fetchMain(){
  fetch(baseURL(mainSheetID)+mainQuery).then(r=>r.text()).then(t=>{
    const json=JSON.parse(t.substr(47).slice(0,-2));
    dataRows=json.table.rows||[];
    renderTable();renderNotices();
    renderSitPlan();
  });
}

function fetchPDFs(){
  fetch(baseURL(pdfSheetID)+"SELECT A,B,C").then(r=>r.text()).then(t=>{
    const json=JSON.parse(t.substr(47).slice(0,-2));
    pdfRows=json.table.rows||[];
    renderPDFs();
  });
}

function renderPDFs(){
  const c=document.getElementById("study");c.innerHTML="";
  const map={};
  pdfRows.forEach(r=>{
    const subj=r.c[0]?.v||"",chap=r.c[1]?.v||"",link=r.c[2]?.v||"";
    if(!map[subj])map[subj]=[];
    map[subj].push({chap,link});
  });
  Object.keys(map).forEach(subj=>{
    c.innerHTML+=`<strong>${subj}</strong>`;
    map[subj].forEach(x=>{c.innerHTML+=`<a href="${x.link}" target="_blank">${x.chap}</a>`;});
  });
}

function renderSitPlan(){
  const div=document.getElementById("sit");div.innerHTML="";
  let names=[];dataRows.forEach(r=>{const n=r.c[5]?.v;if(n)names.push(n);});
  names.forEach((n,i)=>div.innerHTML+=`${i+1}. ${n}<br>`);
}

function shuffleSeats(){
  let names=[];dataRows.forEach(r=>{const n=r.c[5]?.v;if(n)names.push(n);});
  names.sort(()=>Math.random()-0.5);
  const div=document.getElementById("sit");div.innerHTML="";
  names.forEach((n,i)=>div.innerHTML+=`${i+1}. ${n}<br>`);
}

document.getElementById("modeToggle").addEventListener("change",()=>{currentMode=modeToggle.checked?"naughty":"stars";applyModeUI();renderTable();renderNotices();});
applyModeUI();fetchMain();fetchPDFs();

function openMenu(){document.getElementById("sideMenu").classList.add("open");document.getElementById("menuOverlay").classList.add("show");document.body.style.overflow="hidden";}
function closeMenu(){document.getElementById("sideMenu").classList.remove("open");document.getElementById("menuOverlay").classList.remove("show");document.body.style.overflow="";}

function toggleMenu(id){document.getElementById(id).classList.toggle("show");}

document.getElementById("titleTap").addEventListener("click",()=>{clicks++;setTimeout(()=>clicks=0,1000);if(clicks===3){const pass=prompt("Enter password");const sheetPass=dataRows[0]?.c[6]?.v;if(pass===sheetPass){teacher=true;document.getElementById("shuffleBtn").style.display="block";}else alert("Wrong password");}});
</script>
<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./service-worker.js");
  navigator.serviceWorker.addEventListener("controllerchange",()=>{const b=document.getElementById("updateBanner");b.classList.add("show");setTimeout(()=>b.classList.remove("show"),4000);});
}
</script>
</body>
</html>
