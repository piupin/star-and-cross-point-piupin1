<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stars</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#FFD700" />
  <style>
    :root{
      --bg:#fff8e1;
      --card:#ffffff;
      --head:#ffeb3b;
      --border:#ffcc80;
      --text:#333;
      --hover:#ffe082;
      --shadow:0 4px 8px rgba(0,0,0,.2);
    }
    body.naughty {
      --bg:#0a0a0a;
      --card:#121212;
      --head:#2a0000;
      --border:#3a0000;
      --text:#f8d7da;
      --hover:#1a0000;
      --shadow:0 6px 14px rgba(255,0,0,.15);
    }

    *{box-sizing:border-box}
    html, body { height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: "Comic Sans MS", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:12px;
      transition:background .25s ease, color .25s ease;
      overscroll-behavior-y: none;
    }
    /* lock background scroll when menu is open */
    body.menu-open{
      overflow:hidden;
      touch-action:none;
    }

    .topbar{
      width:100%;
      max-width:720px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      padding:8px 6px;
      backdrop-filter:saturate(140%) blur(6px);
      z-index:10;
    }

    h1{
      margin:0 0 6px 0;
      font-size:1.6rem;
      color:#ff5722;
      transition:color .25s ease;
      user-select:none;
      cursor:pointer; /* triple-tap login */
    }
    body.naughty h1{ color:#ff3b3b; }

    .switch-wrap{ display:flex; align-items:center; gap:8px; }
    .mode-label{ font-size:.95rem; user-select:none; }
    .switch{ position:relative; width:58px; height:30px; }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0; background:#ffd54f; border-radius:999px;
      box-shadow:inset 0 2px 6px rgba(0,0,0,.25);
      transition:background .25s ease;
    }
    .knob{
      position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%;
      background:#fff; display:flex; align-items:center; justify-content:center;
      font-size:15px; transition:transform .25s ease;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    input:checked + .slider{ background:#8b0000; }
    input:checked + .slider .knob{ transform:translateX(28px); }

    .table-wrap{
      width:100%; max-width:720px; background:var(--card);
      border-radius:12px; overflow:hidden; box-shadow:var(--shadow);
    }
    table{ width:100%; border-collapse:collapse; background:var(--card); }
    thead th{
      background:var(--head); color:#333; text-align:center;
      padding:10px; font-weight:700;
    }
    tbody td{
      border-top:2px solid var(--border);
      padding:10px; font-size:16px; text-align:center;
    }
    tbody tr:nth-child(even){ background:rgba(255,255,255,.35); }
    body.naughty tbody tr:nth-child(even){ background:#151515; }
    tbody tr:hover{ background:var(--hover); }

    th:nth-child(1), td:nth-child(1){ width:40px; }
    th:nth-child(2), td:nth-child(2){ width:32%; text-align:left; }
    th:nth-child(3), td:nth-child(3){ width:auto; text-align:left; word-break:break-word; font-size:20px; }
    th:nth-child(4), td:nth-child(4){ width:64px; }

    .badge{
      margin:6px 0 2px; padding:6px 10px; border-radius:999px; font-weight:700; font-size:.9rem;
      background:#fff3cd; color:#795548; display:inline-flex; align-items:center; gap:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
    }
    body.naughty .badge{ background:#330000; color:#ffb3b3; }

    .empty{ padding:18px; text-align:center; opacity:.8; }

    /* Notices / Reasons */
    .notice-wrap{
      width:100%; max-width:720px;
      background:var(--card);
      border-radius:10px;
      box-shadow:var(--shadow);
      margin-top:12px;
      padding:10px 14px;
    }
    .notice-wrap h2{
      margin:0 0 6px;
      font-size:1.1rem;
      color:#d32f2f;
    }
    body.naughty .notice-wrap h2{
      color:#ff6666;
    }
    .notice-item{
      margin:4px 0;
      font-size:.95rem;
      line-height:1.3;
    }

    /* Update banner */
    .update-banner {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4caf50;
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 0.95rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: fadeIn 0.4s ease;
    }
    .update-banner.show { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    /* ‚ãÆ button */
    .more-btn{
      border:none;
      background:transparent;
      font-size:22px;
      line-height:1;
      cursor:pointer;
      padding:8px;
      border-radius:10px;
    }
    .more-btn:active{ transform:scale(.96); }

    /* Overlay blur */
    .overlay{
      position:fixed; inset:0; display:none;
      backdrop-filter: blur(6px);
      background: rgba(0,0,0,.2);
      z-index: 999;
      overscroll-behavior: contain;
    }
    .overlay.show{ display:block; }

    /* Right drawer */
    .drawer{
      position:fixed;
      top:0; right:0;
      height:100vh;
      width:75vw; max-width:520px; min-width:300px;
      background:var(--card);
      box-shadow:-8px 0 20px rgba(0,0,0,.25);
      transform: translateX(100%);
      transition: transform .28s ease;
      z-index: 1000;
      display:flex; flex-direction:column;
      will-change: transform;
    }
    .drawer.open{ transform: translateX(0%); }

    .drawer-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:2px solid var(--border);
      background:var(--head);
      flex: 0 0 auto;
    }
    .drawer-title{ margin:0; font-size:1.05rem; }
    .drawer-close{
      border:none; background:transparent; font-size:22px; padding:6px 8px; cursor:pointer;
    }

    .drawer-content{
      padding:10px 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      flex: 1 1 auto;
    }

    /* Collapsible group */
    .group{
      border:2px solid var(--border);
      border-radius:10px;
      margin:10px 0;
      overflow:hidden;
      background:var(--card);
    }
    .group-header{
      width:100%;
      text-align:left;
      background:rgba(0,0,0,.04);
      border:none;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
    }
    .group-header .chev{ font-size:18px; transition: transform .2s ease; }
    .group-header[aria-expanded="true"] .chev{ transform: rotate(90deg); }
    .group-body{ display:none; padding:10px 12px; }
    .group-body.show{ display:block; }

    /* Study list */
    .subject-block{ margin-bottom:10px; }
    .subject-title{ font-weight:700; margin:8px 0 6px; }
    .chapter-link{
      display:block; padding:6px 8px; text-decoration:none;
      color:var(--text); border-radius:8px;
    }
    .chapter-link:hover{ background:var(--hover); }

    /* Sit plan list */
    .plan-list{ list-style:none; padding:0; margin:0; }
    .plan-list li{
      padding:6px 8px; border-bottom:1px dashed var(--border);
    }
    .teacher-actions{
      display:none; gap:8px; margin-top:10px;
    }
    .teacher-actions button{
      padding:8px 10px; border-radius:10px; border:2px solid var(--border);
      background:var(--head); font-weight:700; cursor:pointer;
    }
    .teacher-actions button:active{ transform: scale(.98); }
    .teacher-actions.show{ display:flex; }

    /* tiny footer */
    footer{ margin-top:20px; font-size:0.8rem; color:#888; text-align:center; opacity:0.7; }
 /* === Fix: allow long names and emojis to wrap properly === */
td.points {
  white-space: normal;          /* enable wrapping across lines */
  overflow-wrap: anywhere;      /* break long emoji sequences */
  word-break: break-word;       /* fallback break */
}

th:nth-child(2), td:nth-child(2) {
  width: auto !important;       /* let Name column expand as needed */
}

th:nth-child(3), td:nth-child(3) {
  width: 1% !important;         /* shrink emoji column with wrap */
}

@media (max-width: 720px) {
  th:nth-child(2), td:nth-child(2) {
    width: 55% !important;      /* give more room to names on small screens */
  }
  th:nth-child(3), td:nth-child(3) {
    width: auto !important;
  }
  }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="switch-wrap">
      <label class="switch">
        <input id="modeToggle" type="checkbox" aria-label="Toggle Naughty Mode">
        <div class="slider"><div class="knob">üåü</div></div>
      </label>
      <span class="mode-label" id="modeLabel">Stars</span>
    </div>

    <!-- Title (triple-tap for teacher login) -->
    <h1 id="appTitle">Student Points</h1>

    <!-- ‚ãÆ menu button -->
    <button class="more-btn" id="moreBtn" aria-label="Open menu">‚ãÆ</button>
  </div>

  <div class="badge" id="modeBadge">üåü Stars Ranking</div>

  <div class="table-wrap">
    <table id="studentTable">
      <thead>
        <tr>
          <th>No.</th>
          <th>Name</th>
          <th id="pointsHeader">Stars</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody><tr><td class="empty" colspan="4">Loading‚Ä¶</td></tr></tbody>
    </table>
  </div>

  <!-- Notices/Reasons -->
  <div class="notice-wrap" id="noticeSection">
    <h2 id="noticeTitle">Notices</h2>
    <div id="noticeList">Loading‚Ä¶</div>
  </div>

  <!-- Update banner -->
  <div class="update-banner" id="updateBanner">
    ‚úÖ App updated to latest version
  </div>

  <!-- Overlay + Drawer -->
  <div class="overlay" id="overlay"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-header">
      <h3 class="drawer-title">Menu</h3>
      <button class="drawer-close" id="drawerClose" aria-label="Close">‚úï</button>
    </div>
    <div class="drawer-content">
      <!-- Group 1: Study Materials -->
      <div class="group" id="grpStudy">
        <button class="group-header" data-target="studyBody" aria-expanded="false">
          <span>üìò Study Materials</span>
          <span class="chev">‚ñ∂</span>
        </button>
        <div class="group-body" id="studyBody">
          <div id="studyContainer">Loading‚Ä¶</div>
        </div>
      </div>

      <!-- Group 2: Sit Plan -->
      <div class="group" id="grpSit">
        <button class="group-header" data-target="sitBody" aria-expanded="false">
          <span>ü™ë Sit Plan</span>
          <span class="chev">‚ñ∂</span>
        </button>
        <div class="group-body" id="sitBody">
          <ol class="plan-list" id="sitList"><li>Loading‚Ä¶</li></ol>
          <div class="teacher-actions" id="teacherActions">
            <button id="shuffleBtn">Shuffle & Save</button>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <script>
    /* ====== SHEETS CONFIG ====== */
    // Main sheet (table + notices/reasons + sit plan names + password W1)
    const MAIN_SHEET_ID = "1dpFvFkYwTw4B8laeTQ21mrN78w5P97W3wohI7Pa_2pk";
    const MAIN_SHEET_NAME = "Sheet1";
    // A,B,F,M,P,I,W  -> indices 0..6   (I is index 5, W is index 6)
    const MAIN_QUERY = encodeURIComponent("SELECT A,B,F,M,P,I,W");
    const MAIN_URL = `https://docs.google.com/spreadsheets/d/${MAIN_SHEET_ID}/gviz/tq?sheet=${MAIN_SHEET_NAME}&tq=${MAIN_QUERY}`;

    // Study materials sheet (Subject=A, Chapter=B, Link=C)
    const STUDY_SHEET_ID = "1HFAC0O7INymniAzrQarBPK8Jfyg3lTWBzg22cxg2wVg";
    const STUDY_SHEET_NAME = "Sheet1";
    const STUDY_QUERY = encodeURIComponent("SELECT A,B,C");
    const STUDY_URL = `https://docs.google.com/spreadsheets/d/${STUDY_SHEET_ID}/gviz/tq?sheet=${STUDY_SHEET_NAME}&tq=${STUDY_QUERY}`;

    /* ====== DOM ====== */
    const tbody = document.querySelector("#studentTable tbody");
    const modeToggle = document.querySelector("#modeToggle");
    const modeLabel  = document.querySelector("#modeLabel");
    const modeBadge  = document.querySelector("#modeBadge");
    const pointsHeader = document.querySelector("#pointsHeader");
    const knob = document.querySelector(".knob");

    const noticeTitle = document.getElementById("noticeTitle");
    const noticeList = document.getElementById("noticeList");

    const appTitle = document.getElementById("appTitle");

    const overlay = document.getElementById("overlay");
    const drawer = document.getElementById("drawer");
    const moreBtn = document.getElementById("moreBtn");
    const drawerClose = document.getElementById("drawerClose");

    const studyContainer = document.getElementById("studyContainer");
    const sitList = document.getElementById("sitList");
    const teacherActions = document.getElementById("teacherActions");
    const shuffleBtn = document.getElementById("shuffleBtn");

    /* ====== STATE ====== */
    let dataRows = [];     // main table rows
    let currentMode = "stars";
    let teacherMode = false;
    let sitNames = [];     // from column I
    let sheetPassword = ""; // from W1
    let lastTitleTapTimes = [];

    /* ====== HELPERS ====== */
    function countEmojis(str, emojiRegex){
      if (!str) return 0;
      const m = str.match(emojiRegex);
      return m ? m.length : 0;
    }
    function openDrawer(){
      drawer.classList.add("open");
      drawer.setAttribute("aria-hidden","false");
      overlay.classList.add("show");
      document.body.classList.add("menu-open");
    }
    function closeDrawer(){
      drawer.classList.remove("open");
      drawer.setAttribute("aria-hidden","true");
      overlay.classList.remove("show");
      document.body.classList.remove("menu-open");
    }
    function toggleGroup(btn){
      const targetId = btn.getAttribute("data-target");
      const body = document.getElementById(targetId);
      const expanded = btn.getAttribute("aria-expanded")==="true";
      btn.setAttribute("aria-expanded", String(!expanded));
      body.classList.toggle("show", !expanded);
    }
    function shuffleArray(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    /* ====== TABLE RENDER ====== */
    function renderTable(){
      tbody.innerHTML = "";
      const rows = [];

      dataRows.forEach((row) => {
        const name = row.c[0]?.v || "";
        const starsStr = row.c[1]?.v || "";
        const naughtyStr = row.c[2]?.v || "";

        if (!name.trim()) return;

        const starsTotal   = countEmojis(starsStr, /üåü/g);
        const naughtyTotal = countEmojis(naughtyStr, /‚ùå/g);

        rows.push({
          name,
          raw: currentMode === "stars" ? starsStr : naughtyStr,
          total: currentMode === "stars" ? starsTotal : naughtyTotal
        });
      });

      rows.sort((a,b) => b.total - a.total);

      rows.forEach((r, idx) => {
        let rank = idx + 1;
        if (currentMode === "stars"){
          if (idx === 0) rank = "ü•á";
          else if (idx === 1) rank = "ü•à";
          else if (idx === 2) rank = "ü•â";
        } else {
          if (idx === 0) rank = "‚ò†Ô∏è";
          else if (idx === 1) rank = "üíÄ";
          else if (idx === 2) rank = "ü¶¥";
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${rank}</td>
          <td>${r.name}</td>
          <td class="points">${r.raw || ""}</td>
          <td>${r.total}</td>
        `;
        tbody.appendChild(tr);
      });

      if (rows.length === 0){
        tbody.innerHTML = `<tr><td class="empty" colspan="4">No data</td></tr>`;
      }
    }

    function renderNotices(){
      noticeList.innerHTML = "";

      if (currentMode === "stars"){
        noticeTitle.textContent = "Notices";
        dataRows.forEach((row) => {
          const notice = row.c[3]?.v || "";
          if (notice.trim()){
            const div = document.createElement("div");
            div.className = "notice-item";
            div.textContent = "‚Ä¢ " + notice;
            noticeList.appendChild(div);
          }
        });
      } else {
        noticeTitle.textContent = "Reasons";
        dataRows.forEach((row) => {
          const reason = row.c[4]?.v || "";
          if (reason.trim()){
            const div = document.createElement("div");
            div.className = "notice-item";
            div.textContent = "‚Ä¢ " + reason;
            noticeList.appendChild(div);
          }
        });
      }

      if (!noticeList.innerHTML.trim()){
        noticeList.textContent = "No entries";
      }
    }

    function applyModeUI(){
      if (currentMode === "stars"){
        document.body.classList.remove("naughty");
        modeLabel.textContent = "Stars";
        modeBadge.textContent = "üåü Stars Ranking";
        pointsHeader.textContent = "Stars";
        knob.textContent = "üåü";
      } else {
        document.body.classList.add("naughty");
        modeLabel.textContent = "Naughty";
        modeBadge.textContent = "‚ùå Naughty Ranking";
        pointsHeader.textContent = "Naughty";
        knob.textContent = "‚ùå";
      }
    }

    /* ====== CACHE main table ====== */
    function saveMainCache(){
      try {
        localStorage.setItem("stars_trial_cache_v2", JSON.stringify(dataRows));
      } catch(e){}
    }
    function loadMainCache(){
      try {
        const raw = localStorage.getItem("stars_trial_cache_v2");
        if (!raw) return false;
        dataRows = JSON.parse(raw);
        return Array.isArray(dataRows);
      } catch(e){ return false; }
    }

    /* ====== FETCH main (incl. sit names + password) ====== */
    function deriveSitAndPassFromRows(rows){
      // I column (index 5), W (index 6)
      sitNames = rows.map(r => (r.c?.[5]?.v || "").trim()).filter(Boolean);
      sheetPassword = (rows?.[0]?.c?.[6]?.v || "").toString();
    }

    function fetchMain(){
      return fetch(MAIN_URL)
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substr(47).slice(0, -2));
          const rows = json.table.rows || [];
          dataRows = rows;
          saveMainCache();
          deriveSitAndPassFromRows(rows);
          renderTable();
          renderNotices();
        })
        .catch(() => {
          if (loadMainCache()){
            deriveSitAndPassFromRows(dataRows);
            renderTable();
            renderNotices();
          } else {
            tbody.innerHTML = `<tr><td class="empty" colspan="4">Offline & no saved data</td></tr>`;
            noticeList.textContent = "Offline & no saved data";
          }
        });
    }

        /* ====== STUDY MATERIALS ====== */
    function saveStudyCache(payload){
      try { localStorage.setItem("study_cache_v1", JSON.stringify(payload)); } catch(e){}
    }
    function loadStudyCache(){
      try {
        const raw = localStorage.getItem("study_cache_v1");
        if (!raw) return null;
        return JSON.parse(raw);
      } catch(e){ return null; }
    }
    function renderStudy(subjectMap){
      // subjectMap: { subject: [{chapter, link}, ...], ... }
      studyContainer.innerHTML = "";
      const subjects = Object.keys(subjectMap).sort();
      if (subjects.length === 0){
        studyContainer.textContent = "No study materials";
        return;
      }
      subjects.forEach(sub => {
        const block = document.createElement("div");
        block.className = "subject-block";
        const title = document.createElement("div");
        title.className = "subject-title";
        title.textContent = sub;
        block.appendChild(title);

        subjectMap[sub].forEach(item => {
          const a = document.createElement("a");
          a.className = "chapter-link";
          a.textContent = item.chapter || "(Untitled)";
          if (item.link) {
            a.href = item.link;
            a.target = "_blank";
            a.rel = "noopener";
          } else {
            a.href = "javascript:void(0)";
          }
          block.appendChild(a);
        });

        studyContainer.appendChild(block);
      });
    }
    function fetchStudy(){
      return fetch(STUDY_URL)
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substr(47).slice(0, -2));
          const rows = json.table.rows || [];
          // Build subject -> [{chapter, link}]
          const subjectMap = {};
          rows.forEach(r => {
            const subject = (r.c?.[0]?.v || "").toString().trim();
            const chapter = (r.c?.[1]?.v || "").toString().trim();
            const link    = (r.c?.[2]?.v || "").toString().trim();
            if (!subject || !chapter) return;
            if (!subjectMap[subject]) subjectMap[subject] = [];
            subjectMap[subject].push({ chapter, link });
          });
          saveStudyCache(subjectMap);
          renderStudy(subjectMap);
        })
        .catch(() => {
          const cached = loadStudyCache();
          if (cached) renderStudy(cached);
          else studyContainer.textContent = "Offline & no saved study materials";
        });
    }

    /* ====== SIT PLAN ====== */
    function loadSavedPlan(){
      try {
        const raw = localStorage.getItem("sit_plan_v1");
        if (!raw) return null;
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : null;
      } catch(e){ return null; }
    }
    function savePlan(list){
      try { localStorage.setItem("sit_plan_v1", JSON.stringify(list)); } catch(e){}
    }
    function renderSitPlan(list){
      sitList.innerHTML = "";
      if (!list || list.length === 0){
        sitList.innerHTML = "<li>No names</li>";
        return;
      }
      list.forEach((name, idx) => {
        const li = document.createElement("li");
        li.textContent = (idx+1) + ". " + name;
        sitList.appendChild(li);
      });
    }
    function initSitPlanView(){
      const saved = loadSavedPlan();
      if (saved && saved.length) {
        renderSitPlan(saved);
      } else {
        renderSitPlan(sitNames);
      }
      teacherActions.classList.toggle("show", teacherMode);
    }

    /* ====== HIDDEN TEACHER LOGIN (triple tap title) ====== */
    function handleTitleTap(){
      const now = Date.now();
      lastTitleTapTimes = lastTitleTapTimes.filter(t => now - t < 600);
      lastTitleTapTimes.push(now);
      if (lastTitleTapTimes.length >= 3){
        lastTitleTapTimes = [];
        const input = prompt("Enter teacher password:");
        if (input !== null){
          if (input.toString() === sheetPassword){
            teacherMode = true;
            alert("Teacher mode enabled");
            teacherActions.classList.add("show");
          } else {
            alert("Wrong password");
          }
        }
      }
    }

    /* ====== EVENTS ====== */
    // topbar switch
    modeToggle.addEventListener("change", () => {
      currentMode = modeToggle.checked ? "naughty" : "stars";
      applyModeUI();
      renderTable();
      renderNotices();
    });

    // drawer open/close
    moreBtn.addEventListener("click", openDrawer);
    drawerClose.addEventListener("click", closeDrawer);
    overlay.addEventListener("click", closeDrawer);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeDrawer();
    });
    // prevent touch scrolling the background on iOS when overlay is shown
    overlay.addEventListener("touchmove", (e) => e.preventDefault(), { passive:false });

    // collapsibles (kept collapsed by default)
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".group-header");
      if (btn) toggleGroup(btn);
    });

    // title triple-tap
    appTitle.addEventListener("click", handleTitleTap);

    // shuffle (teachers only)
    shuffleBtn.addEventListener("click", () => {
      if (!teacherMode){ alert("Teacher mode only"); return; }
      const source = sitNames && sitNames.length ? sitNames : [];
      if (source.length === 0){ alert("No names found"); return; }
      const shuffled = shuffleArray(source);
      savePlan(shuffled);
      renderSitPlan(shuffled);
    });

    /* ====== INIT ====== */
    applyModeUI();
    Promise.all([fetchMain(), fetchStudy()]).then(() => {
      initSitPlanView();
    });

    /* ====== SERVICE WORKER HOOKS ====== */
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(console.warn);
      });
      navigator.serviceWorker.addEventListener("controllerchange", () => {
        const banner = document.getElementById("updateBanner");
        banner.classList.add("show");
        setTimeout(() => banner.classList.remove("show"), 4000);
      });
      // listen for SW "reload" message
      navigator.serviceWorker.addEventListener("message", (event) => {
        if (event.data && event.data.action === "reload") {
          window.location.reload();
        }
      });
    }
  </script>

  <footer>Made by Piu</footer>
</body>
</html>


