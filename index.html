<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stars</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#FFD700" />
  <style>
    :root{
      --bg:#fff8e1;
      --card:#ffffff;
      --head:#ffeb3b;
      --border:#ffcc80;
      --text:#333;
      --hover:#ffe082;
      --shadow:0 4px 8px rgba(0,0,0,.2);
    }
    body.naughty {
      --bg:#0a0a0a;
      --card:#121212;
      --head:#2a0000;
      --border:#3a0000;
      --text:#f8d7da;
      --hover:#1a0000;
      --shadow:0 6px 14px rgba(255,0,0,.15);
    }

    *{box-sizing:border-box}
    html, body { height: 100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: "Comic Sans MS", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding:12px;
      transition:background .25s ease, color .25s ease;
    }

    .topbar{
      width:100%;
      max-width:720px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      padding:8px 6px;
      backdrop-filter:saturate(140%) blur(6px);
      z-index:10;
    }

    h1{
      margin:0 0 6px 0;
      font-size:1.6rem;
      color:#ff5722;
      transition:color .25s ease;
      cursor:pointer;
    }
    body.naughty h1{ color:#ff3b3b; }

    .switch-wrap{ display:flex; align-items:center; gap:8px; }
    .mode-label{ font-size:.95rem; user-select:none; }
    .switch{ position:relative; width:58px; height:30px; }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0; background:#ffd54f; border-radius:999px;
      box-shadow:inset 0 2px 6px rgba(0,0,0,.25);
      transition:background .25s ease;
    }
    .knob{
      position:absolute; top:3px; left:3px; width:24px; height:24px; border-radius:50%;
      background:#fff; display:flex; align-items:center; justify-content:center;
      font-size:15px; transition:transform .25s ease;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    input:checked + .slider{ background:#8b0000; }
    input:checked + .slider .knob{ transform:translateX(28px); }

    .table-wrap{
      width:100%; max-width:720px; background:var(--card);
      border-radius:12px; overflow:hidden; box-shadow:var(--shadow);
    }
    table{ width:100%; border-collapse:collapse; background:var(--card); }
    thead th{
      background:var(--head); color:#333; text-align:center;
      padding:10px; font-weight:700;
    }
    tbody td{
      border-top:2px solid var(--border);
      padding:10px; font-size:16px; text-align:center;
    }
    tbody tr:nth-child(even){ background:rgba(255,255,255,.35); }
    body.naughty tbody tr:nth-child(even){ background:#151515; }
    tbody tr:hover{ background:var(--hover); }

    th:nth-child(1), td:nth-child(1){ width:40px; }
    th:nth-child(2), td:nth-child(2){ width:32%; text-align:left; }
    th:nth-child(3), td:nth-child(3){ width:auto; text-align:left; word-break:break-word; font-size:20px; }
    th:nth-child(4), td:nth-child(4){ width:64px; }

    .badge{
      margin:6px 0 2px; padding:6px 10px; border-radius:999px; font-weight:700; font-size:.9rem;
      background:#fff3cd; color:#795548; display:inline-flex; align-items:center; gap:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
    }
    body.naughty .badge{ background:#330000; color:#ffb3b3; }

    .empty{ padding:18px; text-align:center; opacity:.8; }

    /* Notices / Reasons */
    .notice-wrap{
      width:100%; max-width:720px;
      background:var(--card);
      border-radius:10px;
      box-shadow:var(--shadow);
      margin-top:12px;
      padding:10px 14px;
    }
    .notice-wrap h2{
      margin:0 0 6px;
      font-size:1.1rem;
      color:#d32f2f;
    }
    body.naughty .notice-wrap h2{ color:#ff6666; }
    .notice-item{ margin:4px 0; font-size:.95rem; line-height:1.3; }

    /* 3-dot menu button */
    .menu-btn {
      font-size: 22px;
      background:none;
      border:none;
      cursor:pointer;
      color:var(--text);
      line-height:1;
      padding:6px 10px;
    }

    /* Overlay + Side Menu (75% width) */
    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(6px);
      display: none;
      z-index: 100;
    }
    .menu-overlay.show { display: block; }

    .side-menu {
      position: fixed;
      top: 0; right: -75%;
      width: 75%;
      height: 100%;
      background: var(--card);
      box-shadow: -2px 0 8px rgba(0,0,0,0.3);
      transition: right 0.3s ease;
      z-index: 101;
      overflow-y: auto;
      padding: 16px;
      overscroll-behavior: contain; /* keep scroll inside */
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }
    .side-menu.open { right: 0; }

    .menu-hdr {
      display:flex; align-items:center; justify-content:space-between;
      font-weight:700; font-size:1.05rem; margin-bottom:8px;
    }
    .menu-item { font-weight: bold; margin: 12px 0; cursor: pointer; }
    .submenu { display: none; margin-left: 10px; }
    .submenu.show { display:block; }
    .submenu a {
      display:block; margin:6px 0; color:#0077cc; text-decoration:none;
      word-break: break-word;
    }

    .muted { color:#888; font-size:.85rem; margin-top:10px; }

    /* Update banner */
    .update-banner {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4caf50;
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 0.95rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: fadeIn 0.4s ease;
    }
    .update-banner.show { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="switch-wrap">
      <label class="switch">
        <input id="modeToggle" type="checkbox" aria-label="Toggle Naughty Mode">
        <div class="slider"><div class="knob">üåü</div></div>
      </label>
      <span class="mode-label" id="modeLabel">Stars</span>
    </div>
    <h1 id="titleTap">Student Points</h1>
    <button class="menu-btn" aria-label="Open menu" onclick="openMenu()">‚ãÆ</button>
  </div>

  <div class="badge" id="modeBadge">üåü Stars Ranking</div>

  <div class="table-wrap">
    <table id="studentTable">
      <thead>
        <tr>
          <th>No.</th>
          <th>Name</th>
          <th id="pointsHeader">Stars</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody><tr><td class="empty" colspan="4">Loading‚Ä¶</td></tr></tbody>
    </table>
  </div>

  <!-- Notices/Reasons -->
  <div class="notice-wrap" id="noticeSection">
    <h2 id="noticeTitle">Notices</h2>
    <div id="noticeList">Loading‚Ä¶</div>
  </div>

  <!-- Footer -->
  <footer style="margin-top:20px; font-size:0.8rem; color:#888; text-align:center; opacity:0.7;">
    Made by Piu
  </footer>

  <!-- Overlay + Side Menu -->
  <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
  <div class="side-menu" id="sideMenu" role="dialog" aria-label="Menu">
    <div class="menu-hdr">
      <div>Menu</div>
      <button class="menu-btn" aria-label="Close menu" onclick="closeMenu()">‚úï</button>
    </div>

    <div class="menu-item" onclick="toggleSubmenu('materialsSub')">üìò Study Materials</div>
    <div class="submenu" id="materialsSub">Loading‚Ä¶</div>

    <div class="menu-item" onclick="toggleSubmenu('sitplanSub')">ü™ë Sit Plan</div>
    <div class="submenu" id="sitplanSub">Loading‚Ä¶</div>

    <div class="muted">Tap the title ‚ÄúStudent Points‚Äù 3√ó to enter teacher mode.</div>
  </div>

  <!-- Update banner -->
  <div class="update-banner" id="updateBanner">
    ‚úÖ App updated to latest version
  </div>

  <script>
    /* ==========================
       Main sheet (points + password + sit names)
    =========================== */
    const sheetID   = "1dpFvFkYwTw4B8laeTQ21mrN78w5P97W3wohI7Pa_2pk"; // main sheet
    const sheetName = "Sheet1";
    // A,B,F,M,P,W,I  -> indices: 0..6
    const query     = encodeURIComponent("SELECT A,B,F,M,P,W,I");
    const baseURL   = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}&tq=${query}`;

    const tbody = document.querySelector("#studentTable tbody");
    const modeToggle = document.querySelector("#modeToggle");
    const modeLabel  = document.querySelector("#modeLabel");
    const modeBadge  = document.querySelector("#modeBadge");
    const pointsHeader = document.querySelector("#pointsHeader");
    const knob = document.querySelector(".knob");

    const noticeTitle = document.getElementById("noticeTitle");
    const noticeList = document.getElementById("noticeList");

    let dataRows = [];
    let currentMode = "stars";
    let teacherPassword = "";
    let teacherMode = false;
    let seatNames = [];

    function countEmojis(str, emojiRegex){
      if (!str) return 0;
      const m = str.match(emojiRegex);
      return m ? m.length : 0;
    }

    function renderTable(){
      tbody.innerHTML = "";
      const rows = [];

      dataRows.forEach((row) => {
        const name = row.c[0]?.v || "";
        const starsStr = row.c[1]?.v || "";
        const naughtyStr = row.c[2]?.v || "";

        if (!name.trim()) return;

        const starsTotal   = countEmojis(starsStr, /üåü/g);
        const naughtyTotal = countEmojis(naughtyStr, /‚ùå/g);

        rows.push({
          name,
          raw: currentMode === "stars" ? starsStr : naughtyStr,
          total: currentMode === "stars" ? starsTotal : naughtyTotal
        });
      });

      rows.sort((a,b) => b.total - a.total);

      rows.forEach((r, idx) => {
        let rank = idx + 1;
        if (currentMode === "stars"){
          if (idx === 0) rank = "ü•á";
          else if (idx === 1) rank = "ü•à";
          else if (idx === 2) rank = "ü•â";
        } else {
          if (idx === 0) rank = "‚ò†Ô∏è";
          else if (idx === 1) rank = "üíÄ";
          else if (idx === 2) rank = "ü¶¥";
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${rank}</td>
          <td>${r.name}</td>
          <td class="points">${r.raw || ""}</td>
          <td>${r.total}</td>
        `;
        tbody.appendChild(tr);
      });

      if (rows.length === 0){
        tbody.innerHTML = `<tr><td class="empty" colspan="4">No data</td></tr>`;
      }
    }

    function renderNotices(){
      noticeList.innerHTML = "";

      if (currentMode === "stars"){
        noticeTitle.textContent = "Notices";
        dataRows.forEach((row) => {
          const notice = row.c[3]?.v || "";
          if (notice?.trim()){
            const div = document.createElement("div");
            div.className = "notice-item";
            div.textContent = "‚Ä¢ " + notice;
            noticeList.appendChild(div);
          }
        });
      } else {
        noticeTitle.textContent = "Reasons";
        dataRows.forEach((row) => {
          const reason = row.c[4]?.v || "";
          if (reason?.trim()){
            const div = document.createElement("div");
            div.className = "notice-item";
            div.textContent = "‚Ä¢ " + reason;
            noticeList.appendChild(div);
          }
        });
      }

      if (!noticeList.innerHTML.trim()){
        noticeList.textContent = "No entries";
      }
    }

    function applyModeUI(){
      if (currentMode === "stars"){
        document.body.classList.remove("naughty");
        modeLabel.textContent = "Stars";
        modeBadge.textContent = "üåü Stars Ranking";
        pointsHeader.textContent = "Stars";
        knob.textContent = "üåü";
      } else {
        document.body.classList.add("naughty");
        modeLabel.textContent = "Naughty";
        modeBadge.textContent = "‚ùå Naughty Ranking";
        pointsHeader.textContent = "Naughty";
        knob.textContent = "‚ùå";
      }
    }

    function fetchData(){
      fetch(baseURL)
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substr(47).slice(0, -2));
          dataRows = json.table.rows || [];

          teacherPassword = (dataRows[0]?.c[5]?.v || "").toString(); // W1
          seatNames = dataRows.map(r => r.c[6]?.v).filter(Boolean);   // I column list

          renderTable();
          renderNotices();
          // Prepare Sit Plan UI containers if already open
          if (document.getElementById("sitplanSub").classList.contains("show")) {
            renderSitPlanSection();
          }
        })
        .catch(() => {
          tbody.innerHTML = `<tr><td class="empty" colspan="4">Offline & no saved data</td></tr>`;
          noticeList.textContent = "Offline & no saved data";
        });
    }

    modeToggle.addEventListener("change", () => {
      currentMode = modeToggle.checked ? "naughty" : "stars";
      applyModeUI();
      renderTable();
      renderNotices();
    });

    applyModeUI();
    fetchData();

    /* ==========================
       Hidden teacher login (3 taps on title)
    =========================== */
    (function setupTeacherLogin(){
      const title = document.getElementById("titleTap");
      let taps = 0;
      let timer;
      title.addEventListener("click", () => {
        taps++;
        clearTimeout(timer);
        timer = setTimeout(() => {
          if (taps >= 3) {
            const pwd = prompt("Enter teacher password:");
            if (pwd !== null) {
              if ((pwd.trim() || "") === (teacherPassword || "").toString().trim()) {
                teacherMode = true;
                alert("Teacher mode unlocked");
                renderSitPlanSection();
              } else {
                alert("Wrong password");
              }
            }
          }
          taps = 0;
        }, 600);
      });
    })();

    /* ==========================
       Side Menu controls
    =========================== */
    function openMenu() {
      document.getElementById("sideMenu").classList.add("open");
      document.getElementById("menuOverlay").classList.add("show");
      // lock background scroll
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
    }
    function closeMenu() {
      document.getElementById("sideMenu").classList.remove("open");
      document.getElementById("menuOverlay").classList.remove("show");
      // restore scroll
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
    }
    document.addEventListener("keydown", (e)=>{
      if (e.key === "Escape") closeMenu();
    });

    function toggleSubmenu(id){
      const el = document.getElementById(id);
      el.classList.toggle("show");
      if (id === "materialsSub" && el.classList.contains("show")) {
        if (!el.dataset.loaded) {
          loadMaterials();
        }
      }
      if (id === "sitplanSub" && el.classList.contains("show")) {
        renderSitPlanSection();
      }
    }

    /* ==========================
       Study Materials (2nd sheet)
    =========================== */
    const materialsSheetID = "1HFAC0O7INymniAzrQarBPK8Jfyg3lTWBzg22cxg2wVg";
    const materialsQuery   = encodeURIComponent("SELECT A,B,C");
    const materialsURL     = `https://docs.google.com/spreadsheets/d/${materialsSheetID}/gviz/tq?sheet=Sheet1&tq=${materialsQuery}`;

    function loadMaterials(){
      const materialsDiv = document.getElementById("materialsSub");
      materialsDiv.textContent = "Loading‚Ä¶";
      fetch(materialsURL)
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substr(47).slice(0, -2));
          const rows = json.table.rows || [];

          materialsDiv.innerHTML = "";
          const subjects = {};
          rows.forEach(r=>{
            const subj = r.c[0]?.v || "";
            const chap = r.c[1]?.v || "";
            const link = r.c[2]?.v || "";
            if(!subj || !chap || !link) return;
            if(!subjects[subj]) subjects[subj]=[];
            subjects[subj].push({chap,link});
          });

          Object.keys(subjects).forEach(subj=>{
            const h = document.createElement("div");
            h.style.marginTop="8px"; h.style.fontWeight="bold";
            h.textContent = subj;
            materialsDiv.appendChild(h);
            subjects[subj].forEach(item=>{
              const a = document.createElement("a");
              a.textContent=item.chap;
              a.href=item.link;
              a.target="_blank";
              a.rel="noopener";
              materialsDiv.appendChild(a);
            });
          });

          if (!materialsDiv.innerHTML.trim()){
            materialsDiv.textContent = "No materials yet.";
          }
          materialsDiv.dataset.loaded = "1";
          // cache for offline view next time
          try { localStorage.setItem("materials_cache_v1", JSON.stringify(subjects)); } catch(e){}
        })
        .catch(()=>{
          // try cache
          try {
            const cache = JSON.parse(localStorage.getItem("materials_cache_v1")||"{}");
            const materialsDiv2 = document.getElementById("materialsSub");
            materialsDiv2.innerHTML = "";
            Object.keys(cache).forEach(subj=>{
              const h = document.createElement("div");
              h.style.marginTop="8px"; h.style.fontWeight="bold";
              h.textContent = subj;
              materialsDiv2.appendChild(h);
              cache[subj].forEach(item=>{
                const a = document.createElement("a");
                a.textContent=item.chap;
                a.href=item.link;
                a.target="_blank";
                a.rel="noopener";
                materialsDiv2.appendChild(a);
              });
            });
            if (!materialsDiv2.innerHTML.trim()){
              materialsDiv2.textContent = "Offline & no saved materials";
            }
            materialsDiv2.dataset.loaded = "1";
          } catch(e) {
            materialsDiv.textContent = "Failed to load";
          }
        });
    }

    /* ==========================
       Sit Plan (deterministic per day)
    =========================== */
    function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=(h<<13)|(h>>>19);}return function(){h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);return (h^=h>>>16)>>>0;};}
    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return ((t^(t>>>14))>>>0)/4294967296;};}
    function shuffleWithSeed(arr, seedStr){
      const seed = xmur3(seedStr)();
      const rand = mulberry32(seed);
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(rand()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }
    function todaySeed(){
      const d = new Date();
      const day = d.toISOString().slice(0,10); // YYYY-MM-DD
      return day + "|" + (teacherPassword||"");
    }

    function renderSitPlanSection(){
      const sub = document.getElementById("sitplanSub");
      sub.innerHTML = "";
      const listWrap = document.createElement("div");
      listWrap.style.marginTop = "6px";

            // Button only for teacher
      if (teacherMode) {
        const btn = document.createElement("button");
        btn.textContent = "üîÄ Generate Today‚Äôs Plan";
        btn.style.margin="6px 0 10px";
        btn.style.padding="8px 12px";
        btn.style.border="1px solid #ccc";
        btn.style.borderRadius="8px";
        btn.style.background="#fff";
        btn.style.cursor="pointer";
        btn.onclick = () => {
          // Re-render (deterministic for the day)
          renderSitPlanSection();
        };
        sub.appendChild(btn);
      }

      // compute plan
      const names = (seatNames && seatNames.length) ? seatNames : [];
      if (!names.length){
        listWrap.textContent = "No names found for sit plan (column I).";
        sub.appendChild(listWrap);
        return;
      }
      const plan = shuffleWithSeed(names, todaySeed());
      const ol = document.createElement("ol");
      plan.forEach(n => {
        const li = document.createElement("li");
        li.textContent = n;
        ol.appendChild(li);
      });
      listWrap.appendChild(ol);
      sub.appendChild(listWrap);
    }

    /* ==========================
       PWA update banner hook
    =========================== */
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(console.warn);
      });
      // reload trigger from SW
      navigator.serviceWorker.addEventListener("message", (e) => {
        if (e.data && e.data.action === "reload") {
          window.location.reload();
        }
      });
      // visual banner when controller changes
      navigator.serviceWorker.addEventListener("controllerchange", () => {
        const banner = document.getElementById("updateBanner");
        banner.classList.add("show");
        setTimeout(() => banner.classList.remove("show"), 4000);
      });
    }
  </script>
</body>
</html>
